<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudAirlines - Premium Flight Booking</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --accent-color: #10b981;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', system-ui, -apple-system, sans-serif; }

        body { background-color: var(--bg-color); color: var(--text-main); line-height: 1.5; }

        header { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 2rem; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        main { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }

        .section-title { margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem; }

        #flight-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }

        .flight-card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #e5e7eb; position: relative; overflow: hidden; }
        .flight-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
        .flight-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary-color); }

        .flight-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .airline { font-weight: 700; color: var(--primary-color); }
        .flight-id { font-size: 0.8rem; color: var(--text-muted); background: #f3f4f6; padding: 0.2rem 0.5rem; border-radius: 4px; }

        .route { display: flex; align-items: center; justify-content: space-between; margin: 1.5rem 0; font-weight: 600; }
        .route-city { text-align: center; flex: 1; }
        .plane-icon { color: var(--text-muted); padding: 0 1rem; }

        .flight-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee; }
        .price { font-size: 1.5rem; font-weight: 800; color: var(--accent-color); }

        button { background: var(--primary-color); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        button:hover { background: var(--secondary-color); }
        .btn-book { width: 100%; margin-top: 1rem; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 5% auto; padding: 2rem; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; }
        
        .booking-summary { background: #f9fafb; padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem; border: 1px dashed #d1d5db; }
        .summary-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .total-row { border-top: 1px solid #e5e7eb; margin-top: 0.5rem; padding-top: 0.5rem; font-weight: 800; font-size: 1.2rem; color: var(--accent-color); }

        .success-overlay { text-align: center; padding: 2rem; }
        .success-icon { font-size: 4rem; color: var(--accent-color); margin-bottom: 1rem; }

        .loading { text-align: center; padding: 3rem; color: var(--text-muted); }
    </style>
</head>
<body>

    <header>
        <h1>CloudAirlines</h1>
        <p>Your Journey, Our Priority</p>
    </header>

    <main>
        <div class="section-title">
            <h2>Available Flights</h2>
            <p style="color: var(--text-muted)">Discover your next destination</p>
        </div>

        <div id="flight-results">
            <div class="loading">Loading flights...</div>
        </div>
    </main>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div id="bookingFormContainer">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 id="modalTitle">Complete Your Booking</h2>
                    <span style="cursor: pointer; font-size: 1.5rem;" onclick="closeModal()">&times;</span>
                </div>
                
                <form id="bookingForm">
                    <input type="hidden" id="selectedFlightId">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="passengerName" required placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label>Passport Number</label>
                            <input type="text" id="passengerPassport" required placeholder="A1234567">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="passengerEmail" required placeholder="john@example.com">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Select Seat</label>
                            <select id="seatSelection" required></select>
                        </div>
                        <div class="form-group">
                            <label>Meal Preference</label>
                            <select id="mealSelection" required></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Discount Code</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="discountCode" placeholder="TRY FLY20">
                            <button type="button" onclick="applyDiscount()" style="background: #4b5563;">Apply</button>
                        </div>
                    </div>

                    <div class="booking-summary">
                        <div class="summary-row">
                            <span>Base Fare</span>
                            <span id="summaryBasePrice">$0.00</span>
                        </div>
                        <div class="summary-row" id="discountRow" style="display: none; color: var(--accent-color);">
                            <span>Discount</span>
                            <span id="summaryDiscount">-$0.00</span>
                        </div>
                        <div class="summary-row total-row">
                            <span>Total Amount</span>
                            <span id="summaryTotal">$0.00</span>
                        </div>
                    </div>

                    <button type="submit" class="btn-book" style="padding: 1rem; font-size: 1.1rem; margin-top: 1.5rem;">Confirm & Pay</button>
                </form>
            </div>

            <div id="successMessage" class="success-overlay" style="display: none;">
                <div class="success-icon">âœ“</div>
                <h2>Booking Confirmed!</h2>
                <p style="margin: 1rem 0; color: var(--text-muted)">Your flight has been reserved. Booking ID: <strong id="resBookingId"></strong></p>
                <div id="resSummary" class="booking-summary" style="text-align: left;"></div>
                <button onclick="closeModal()" style="margin-top: 2rem;">Close</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:8001/api' 
            : '/api';

        let flights = [];
        let currentFlight = null;
        let basePrice = 0;

        async function init() {
            await fetchFlights();
        }

        async function fetchFlights() {
            const container = document.getElementById('flight-results');
            try {
                const res = await fetch(`${API_BASE}/flights`);
                flights = await res.json();
                
                container.innerHTML = '';
                flights.forEach(f => {
                    const card = document.createElement('div');
                    card.className = 'flight-card';
                    card.innerHTML = `
                        <div class="flight-header">
                            <span class="airline">${f.airline}</span>
                            <span class="flight-id">${f.id}</span>
                        </div>
                        <div class="route">
                            <div class="route-city">${f.origin}</div>
                            <div class="plane-icon">âœˆ</div>
                            <div class="route-city">${f.destination}</div>
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-muted); text-align: center; margin-bottom: 1rem;">
                            ðŸ•’ ${f.time}
                        </div>
                        <div class="flight-footer">
                            <span class="price">$${f.price.toFixed(2)}</span>
                            <button onclick="openBooking('${f.id}')">Select Flight</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (e) {
                container.innerHTML = '<div class="loading" style="color: #ef4444">Failed to load flights. Is the backend running?</div>';
            }
        }

        async function openBooking(flightId) {
            currentFlight = flights.find(f => f.id === flightId);
            basePrice = currentFlight.price;
            
            document.getElementById('selectedFlightId').value = flightId;
            document.getElementById('summaryBasePrice').textContent = `$${basePrice.toFixed(2)}`;
            updateTotal();

            // Fetch Seats and Meals
            try {
                const [seatsRes, mealsRes] = await Promise.all([
                    fetch(`${API_BASE}/flights/${flightId}/seats`),
                    fetch(`${API_BASE}/meals`)
                ]);
                
                const { seats } = await seatsRes.json();
                const { meals } = await mealsRes.json();

                const seatSelect = document.getElementById('seatSelection');
                seatSelect.innerHTML = seats.map(s => `<option value="${s}">${s}</option>`).join('');

                const mealSelect = document.getElementById('mealSelection');
                mealSelect.innerHTML = meals.map(m => `<option value="${m}">${m}</option>`).join('');

                document.getElementById('bookingModal').style.display = 'block';
                document.getElementById('bookingFormContainer').style.display = 'block';
                document.getElementById('successMessage').style.display = 'none';
            } catch (e) {
                alert("Error loading booking details");
            }
        }

        function applyDiscount() {
            updateTotal();
        }

        function updateTotal() {
            const code = document.getElementById('discountCode').value.toUpperCase();
            let discount = 0;
            
            // Simple frontend preview of discounts
            if (code === 'FLY20') discount = basePrice * 0.20;
            else if (code === 'SAVE10') discount = basePrice * 0.10;
            else if (code === 'WELCOME50') discount = basePrice * 0.50;

            if (discount > 0) {
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('summaryDiscount').textContent = `-$${discount.toFixed(2)}`;
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }

            document.getElementById('summaryTotal').textContent = `$${(basePrice - discount).toFixed(2)}`;
        }

        document.getElementById('bookingForm').onsubmit = async (e) => {
            e.preventDefault();
            
            const payload = {
                flight_id: currentFlight.id,
                passenger: {
                    name: document.getElementById('passengerName').value,
                    email: document.getElementById('passengerEmail').value,
                    passport: document.getElementById('passengerPassport').value
                },
                seat: document.getElementById('seatSelection').value,
                meal: document.getElementById('mealSelection').value,
                discount_code: document.getElementById('discountCode').value
            };

            try {
                const res = await fetch(`${API_BASE}/bookings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    const booking = await res.json();
                    showSuccess(booking);
                } else {
                    alert("Booking failed. Please check details.");
                }
            } catch (e) {
                alert("Network error occurred.");
            }
        };

        function showSuccess(b) {
            document.getElementById('bookingFormContainer').style.display = 'none';
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('resBookingId').textContent = b.booking_id;
            
            document.getElementById('resSummary').innerHTML = `
                <p><strong>Passenger:</strong> ${b.passenger.name}</p>
                <p><strong>Flight:</strong> ${b.flight.origin} to ${b.flight.destination}</p>
                <p><strong>Seat:</strong> ${b.seat} | <strong>Meal:</strong> ${b.meal}</p>
                <p><strong>Price Paid:</strong> $${b.final_price.toFixed(2)}</p>
            `;
        }

        function closeModal() {
            document.getElementById('bookingModal').style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('bookingModal')) closeModal();
        }

        init();
    </script>
</body>
</html>
